<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flappy Test</title>
<style>
  body {
    margin: 0;
    background: #70c5ce;
    overflow: hidden;
  }
  canvas {
    display: block;
    margin: auto;
    background: #70c5ce;
  }
  #tap {
    position: absolute;
    top: 50%;
    width: 100%;
    text-align: center;
    font-size: 30px;
    font-weight: bold;
    color: white;
    text-shadow: 2px 2px black;
  }
</style>
</head>

<body>

<div id="tap">TAP TO START</div>
<canvas id="c" width="360" height="640"></canvas>

<script>
const c = document.getElementById("c");
const ctx = c.getContext("2d");

let started = false;

const bird = {
  x: 80,
  y: 300,
  r: 12,
  v: 0
};

const gravity = 0.5;
const jump = -8;

const pipeW = 50;
const gap = 150;
let pipes = [];

function addPipe() {
  let top = Math.random() * 250 + 50;
  pipes.push({ x: c.width, top: top });
}

function reset() {
  bird.y = 300;
  bird.v = 0;
  pipes = [];
  started = false;
  document.getElementById("tap").style.display = "block";
}

function update() {
  if (!started) return;

  bird.v += gravity;
  bird.y += bird.v;

  if (bird.y < 0 || bird.y > c.height) reset();

  if (pipes.length === 0 || pipes[pipes.length - 1].x < 200) {
    addPipe();
  }

  for (let p of pipes) {
    p.x -= 2.5;

    // collision
    if (
      bird.x + bird.r > p.x &&
      bird.x - bird.r < p.x + pipeW &&
      (bird.y - bird.r < p.top ||
       bird.y + bird.r > p.top + gap)
    ) {
      reset();
    }
  }

  pipes = pipes.filter(p => p.x > -pipeW);
}

function draw() {
  ctx.clearRect(0,0,c.width,c.height);

  // bird
  ctx.fillStyle = "yellow";
  ctx.beginPath();
  ctx.arc(bird.x, bird.y, bird.r, 0, Math.PI*2);
  ctx.fill();

  // pipes
  ctx.fillStyle = "green";
  for (let p of pipes) {
    ctx.fillRect(p.x, 0, pipeW, p.top);
    ctx.fillRect(p.x, p.top + gap, pipeW, c.height);
  }
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();

function start() {
  if (!started) {
    started = true;
    document.getElementById("tap").style.display = "none";
  }
  bird.v = jump;
}

document.addEventListener("keydown", e => {
  if (e.code === "Space") start();
});
c.addEventListener("mousedown", start);
c.addEventListener("touchstart", start);
</script>

</body>
</html>
